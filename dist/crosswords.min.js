"use strict";function updateDOM(e){for(var l=e.currentClue,r=0;r<e.cells.length;r++)for(var t=0;t<e.cells[r].length;t++){var n=e.cells[r][t];n.light===!0&&(n.acrossClue===l||n.downClue===l?addClass(n.cellElement.querySelector("input"),"active"):removeClass(n.cellElement.querySelector("input"),"active"))}}function createCellElement(e){var l=document.createElement("div");if(l.className="cwcell",e.cellElement=l,!e.light)return l;l.className+=" light";var r=document.createElement("input");if(r.maxLength=1,l.appendChild(r),e.clueLabel){var t=document.createElement("div");t.className="cwcluelabel",t.innerHTML=e.clueLabel,l.appendChild(t)}return r.addEventListener("focus",function(e){var l=e.target.parentNode,r=getCellElementData(l),t=r.crosswordModel;t.currentX=r.cell.x,t.currentY=r.cell.y;var n=t.currentClue&&t.currentClue===r.cell.downClue?r.cell.downClue||r.cell.acrossClue:r.cell.acrossClue||r.cell.downClue;t.currentClue!==n&&(t.currentClue=n,updateDOM(t),stateChange(t,"clueSelected"))}),l.addEventListener("keydown",function(e){if(8===e.keyCode){e.preventDefault(),e.target.value="";var l=e.target.parentNode,r=getCellElementData(l),t=r.cell,n=r.crosswordModel.currentClue,o=t.acrossClue===n?t.acrossClueLetterIndex:t.downClueLetterIndex,a=o-1;a>=0&&n.cells[a].cellElement.querySelector("input").focus()}else if(9===e.keyCode){e.preventDefault();for(var l=e.target.parentNode,r=getCellElementData(l),n=r.crosswordModel.currentClue,s=r.crosswordModel,c=n.across?s.acrossClues:s.downClues,u=0;u<c.length;u++)if(n===c[u]){var d=null;d=u<c.length-1?c[u+1]:n.across?s.downClues[0]:s.acrossClues[0],s.currentClue=d,updateDOM(s),d.cells[0].cellElement.querySelector("input").focus({internal:!0});break}}else if(13===e.keyCode){e.preventDefault();var l=e.target.parentNode,r=getCellElementData(l),t=r.cell,s=r.crosswordModel;t.acrossClue&&t.downClue&&(s.currentClue=t.acrossClue===s.currentClue?t.downClue:t.acrossClue,updateDOM(s))}}),l.addEventListener("keypress",function(e){32===e.keyCode&&e.preventDefault(),e.target.value="";var l=e.target.parentNode,r=getCellElementData(l),t=r.cell,n=r.crosswordModel.currentClue,o=t.acrossClue===n?t.acrossClueLetterIndex:t.downClueLetterIndex,a=o+1;a<n.cells.length&&n.cells[a].cellElement.querySelector("input").focus()}),l.addEventListener("keyup",function(e){switch(e.keyCode){case 37:var l=e.target.parentNode,r=getCellElementData(l),t=r.cell,n=t.x,o=t.y;t.x>0&&r.crosswordModel.cells[n-1][o].light===!0&&r.crosswordModel.cells[n-1][o].cellElement.querySelector("input").focus();break;case 38:var l=e.target.parentNode,r=getCellElementData(l),t=r.cell,n=t.x,o=t.y;t.y>0&&r.crosswordModel.cells[n][o-1].light===!0&&r.crosswordModel.cells[n][o-1].cellElement.querySelector("input").focus();break;case 39:var l=e.target.parentNode,r=getCellElementData(l),t=r.cell,a=r.crosswordModel.width,n=t.x,o=t.y;t.x+1<a&&r.crosswordModel.cells[n+1][o].light===!0&&r.crosswordModel.cells[n+1][o].cellElement.querySelector("input").focus();break;case 40:var l=e.target.parentNode,r=getCellElementData(l),t=r.cell,s=r.crosswordModel.height,n=t.x,o=t.y;t.y+1<s&&r.crosswordModel.cells[n][o+1].light===!0&&r.crosswordModel.cells[n][o+1].cellElement.querySelector("input").focus();break;case 9:}}),l}function crossword(e){validateOptions(e);var l=buildCrosswordModel(e.crosswordDefinition);l.currentX=null,l.currentY=null,l.currentClue=null;var r=l.width,t=l.height,n=document.createElement("div");n.className="crossword";for(var o=0;t>o;o++){var a=document.createElement("div");a.className="cwrow",n.appendChild(a);for(var s=0;r>s;s++){var c=l.cells[s][o],u=createCellElement(c);a.appendChild(u),cellMap.push({cellElement:u,crosswordModel:l,cell:c})}}return e.element.appendChild(n),l}var cellMap=[],getCellElementData=function(e){for(var l=0;l<cellMap.length;l++)if(cellMap[l].cellElement===e)return cellMap[l];return null},getCellData=function(e){for(var l=0;l<cellMap.length;l++)if(cellMap[l].cell===e)return cellMap[l];return null},removeClass=function(e,l){var r=new RegExp("(?:^|\\s)"+l+"(?!\\S)","g");e.className=e.className.replace(r,"")},addClass=function(e,l){e.className+=" "+l},validateOptions=function(e){if(null===e||void 0===e)throw new Error("An options parameter must be passed to 'crossword'.");if(null===e.element||void 0===e.element)throw new Error("The crossword must be initialised with a valid DOM element.");if(null===e.crosswordDefinition||void 0===e.crosswordDefinition)throw new Error("The crossword must be initialised with a crossword definition.")},stateChange=function(e,l,r){var t=e.onStateChanged;t&&t({message:l,data:r})},buildCrosswordModel=function(e){var l=e.width,r=e.height;if(void 0===l||null===l||0>l||void 0===r||null===r||0>r)throw new Error("The crossword bounds are invalid.");for(var t=[],n=0;l>n;n++){t[n]=[];for(var o=0;r>o;o++)t[n][o]={x:n,y:o,light:!1,clueLabel:null,acrossClue:null,acrossClueLetterIndex:null,downClue:null,downClueLetterIndex:null}}for(var a={width:l,height:r,cells:t,acrossClues:[],downClues:[],onStateChanged:null},s=e.acrossClues.concat(e.downClues),c=0;c<s.length;c++){var u=c<e.acrossClues.length,d=s[c],i={number:d.number,code:d.number+(u?"a":"d"),answer:d.answer,x:d.x-1,y:d.y-1,across:u,length:[],totalLength:0,clue:d.clue,cells:[]};if(a[u?"acrossClues":"downClues"].push(i),i.x<0||i.x>=l||i.y<0||i.y>=r)throw new Error("Clue "+i.code+" doesn't start in the bounds.");for(var w=0;w<d.length.length;w++)i.length.push(d.length[w]),i.totalLength+=d.length[w];if(u){if(i.x+i.totalLength>l)throw new Error("Clue "+i.code+" exceeds horizontal bounds.")}else if(i.y+i.totalLength>r)throw new Error("Clue "+i.code+" exceeds vertical bounds.");for(var n=i.x,o=i.y,C=0;C<i.totalLength;C++){var h=t[n][o];if(h.light=!0,h[u?"acrossClue":"downClue"]=i,h[u?"acrossClueLetterIndex":"downClueLetterIndex"]=C,i.cells.push(h),i.answer){if(void 0!==h.answer&&h.answer!==i.answer[C])throw new Error("Clue "+i.code+" answer at ("+(n+1)+", "+(o+1)+") is not coherent with previous clue ("+h.acrossClue.code+") answer.");h.answer=i.answer[C]}if(0===C){if(null!==h.clueLabel&&h.clueLabel!==i.number)throw new Error("Clue "+i.code+" has a label which is inconsistent with another clue ("+h.acrossClue.code+").");h.clueLabel=i.number}u?n++:o++}}return a};